<!-- Mobile Hosts & VMs Section -->
<div class="mobile-section">
    <div class="section-header hosts-header">
        <h2>Hosts & VMs</h2>
        <p>Hypervisor Management - VM Orchestration</p>
    </div>
    <div class="hosts-tabs">
        <button class="hosts-tab active" data-tab="hypervisors">Hypervisors</button>
        <button class="hosts-tab" data-tab="vms">Virtual Machines</button>
    </div>
    <div id="hosts-hypervisors" class="hosts-content active">
        <div id="hypervisors-table-container"></div>
    </div>
    <div id="hosts-vms" class="hosts-content">
        <div id="vms-table-container"></div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // Helpers
    function escapeHtml(text) {
        if (text == null || text === '--') return '--';
        var div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
    function capitalize(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1) : ''; }

    function getHvStatusClass(status) {
        if (!status) return 'offline';
        var s = String(status).toLowerCase();
        if (s === 'operational') return 'operational';
        if (s === 'warning') return 'warning';
        if (s === 'critical') return 'critical';
        return 'offline';
    }
    function getVmStatusClass(status) {
        if (!status) return 'offline';
        var s = String(status).toLowerCase();
        if (s === 'running') return 'operational';
        if (s === 'suspended') return 'warning';
        if (s === 'error') return 'critical';
        return 'offline';
    }

    // Hypervisor card
    function renderHvCard(hv, index, table) {
        var statusClass = table.config.getStatusClass(hv.status);
        return '<div class="mobile-table-card clickable" data-index="' + index + '">' +
            '<div class="mobile-table-card-header">' +
                '<div>' +
                    '<h4 class="mobile-table-card-title">' + escapeHtml(hv.name) + '</h4>' +
                    '<p class="mobile-table-card-subtitle">' + escapeHtml(hv.type) + ' | ' + escapeHtml(hv.cluster) + '</p>' +
                '</div>' +
                '<div class="mobile-table-status ' + statusClass + '">' +
                    '<span class="mobile-table-status-indicator"></span>' +
                    '<span>' + capitalize(hv.status) + '</span>' +
                '</div>' +
            '</div>' +
            '<div class="mobile-table-card-body">' +
                '<div class="host-metrics">' +
                    '<div class="host-metric"><span class="host-metric-label">CPU</span><span class="host-metric-value">' + hv.cpuUsage + '%</span></div>' +
                    '<div class="host-metric"><span class="host-metric-label">Memory</span><span class="host-metric-value">' + hv.memoryUsage + '%</span></div>' +
                    '<div class="host-metric"><span class="host-metric-label">VMs</span><span class="host-metric-value">' + hv.vmRunning + '/' + hv.vmCount + '</span></div>' +
                    '<div class="host-metric"><span class="host-metric-label">DC</span><span class="host-metric-value">' + escapeHtml(hv.datacenter) + '</span></div>' +
                '</div>' +
            '</div>' +
        '</div>';
    }

    // VM card
    function renderVmCard(vm, index, table) {
        var statusClass = table.config.getStatusClass(vm.status);
        return '<div class="mobile-table-card clickable" data-index="' + index + '">' +
            '<div class="mobile-table-card-header">' +
                '<div>' +
                    '<h4 class="mobile-table-card-title">' + escapeHtml(vm.name) + '</h4>' +
                    '<p class="mobile-table-card-subtitle">' + escapeHtml(vm.os) + ' | ' + escapeHtml(vm.hypervisor) + '</p>' +
                '</div>' +
                '<div class="mobile-table-status ' + statusClass + '">' +
                    '<span class="mobile-table-status-indicator"></span>' +
                    '<span>' + capitalize(vm.status) + '</span>' +
                '</div>' +
            '</div>' +
            '<div class="mobile-table-card-body">' +
                '<div class="host-metrics">' +
                    '<div class="host-metric"><span class="host-metric-label">CPU</span><span class="host-metric-value">' + vm.cpuUsage + '%</span></div>' +
                    '<div class="host-metric"><span class="host-metric-label">Mem</span><span class="host-metric-value">' + vm.memoryUsed + '/' + vm.memory + ' GB</span></div>' +
                    '<div class="host-metric"><span class="host-metric-label">Disk</span><span class="host-metric-value">' + vm.diskUsage + '%</span></div>' +
                    '<div class="host-metric"><span class="host-metric-label">IP</span><span class="host-metric-value">' + escapeHtml(vm.ipAddress) + '</span></div>' +
                '</div>' +
            '</div>' +
        '</div>';
    }

    // Hypervisor detail popup
    function showHvDetail(hv) {
        var overviewContent =
            '<div class="detail-section">' +
                '<div class="detail-section-title">Host Information</div>' +
                '<div class="detail-row"><span class="detail-label">Hostname</span><span class="detail-value">' + escapeHtml(hv.hostname) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Type</span><span class="detail-value">' + escapeHtml(hv.type) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Version</span><span class="detail-value">' + escapeHtml(hv.version) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Datacenter</span><span class="detail-value">' + escapeHtml(hv.datacenter) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Cluster</span><span class="detail-value">' + escapeHtml(hv.cluster) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">IP Address</span><span class="detail-value">' + escapeHtml(hv.ipAddress) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Manufacturer</span><span class="detail-value">' + escapeHtml(hv.manufacturer) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Model</span><span class="detail-value">' + escapeHtml(hv.model) + '</span></div>' +
            '</div>';

        var resourcesContent =
            '<div class="detail-section">' +
                '<div class="detail-section-title">CPU</div>' +
                '<div class="detail-row"><span class="detail-label">CPU Model</span><span class="detail-value">' + escapeHtml(hv.cpuModel) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Cores</span><span class="detail-value">' + hv.cpuCores + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Usage</span><span class="detail-value">' + hv.cpuUsage + '%</span></div>' +
            '</div>' +
            '<div class="detail-section">' +
                '<div class="detail-section-title">Memory</div>' +
                '<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value">' + hv.memoryTotal + ' GB</span></div>' +
                '<div class="detail-row"><span class="detail-label">Used</span><span class="detail-value">' + hv.memoryUsed + ' GB (' + hv.memoryUsage + '%)</span></div>' +
            '</div>' +
            '<div class="detail-section">' +
                '<div class="detail-section-title">Storage</div>' +
                '<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value">' + hv.storageTotal + ' TB</span></div>' +
                '<div class="detail-row"><span class="detail-label">Used</span><span class="detail-value">' + hv.storageUsed + ' TB</span></div>' +
            '</div>';

        var vmsContent =
            '<div class="detail-section">' +
                '<div class="detail-section-title">Virtual Machines</div>' +
                '<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value">' + hv.vmCount + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Running</span><span class="detail-value operational">' + hv.vmRunning + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Stopped</span><span class="detail-value">' + hv.vmStopped + '</span></div>' +
            '</div>' +
            '<div class="detail-section">' +
                '<div class="detail-section-title">Network</div>' +
                '<div class="detail-row"><span class="detail-label">Interfaces</span><span class="detail-value">' + hv.networkInterfaces + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">vSwitches</span><span class="detail-value">' + hv.vSwitches + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Datastores</span><span class="detail-value">' + hv.datastores + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Uptime</span><span class="detail-value">' + hv.uptime + ' days</span></div>' +
            '</div>';

        MobilePopup.show({
            title: hv.name,
            size: 'large',
            showFooter: false,
            tabs: [
                { id: 'overview', label: 'Overview', content: overviewContent },
                { id: 'resources', label: 'Resources', content: resourcesContent },
                { id: 'vms', label: 'VMs & Network', content: vmsContent }
            ]
        });
    }

    // VM detail popup
    function showVmDetail(vm) {
        var overviewContent =
            '<div class="detail-section">' +
                '<div class="detail-section-title">VM Information</div>' +
                '<div class="detail-row"><span class="detail-label">Hostname</span><span class="detail-value">' + escapeHtml(vm.name) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">OS</span><span class="detail-value">' + escapeHtml(vm.os) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Hypervisor</span><span class="detail-value">' + escapeHtml(vm.hypervisor) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Purpose</span><span class="detail-value">' + escapeHtml(vm.purpose) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Status</span><span class="detail-value ' + getVmStatusClass(vm.status) + '">' + capitalize(vm.status) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">IP Address</span><span class="detail-value">' + escapeHtml(vm.ipAddress) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">MAC</span><span class="detail-value">' + escapeHtml(vm.macAddress) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">VLAN</span><span class="detail-value">' + vm.vlan + '</span></div>' +
            '</div>';

        var resourcesContent =
            '<div class="detail-section">' +
                '<div class="detail-section-title">CPU</div>' +
                '<div class="detail-row"><span class="detail-label">Cores</span><span class="detail-value">' + vm.cpuCores + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Usage</span><span class="detail-value">' + vm.cpuUsage + '%</span></div>' +
            '</div>' +
            '<div class="detail-section">' +
                '<div class="detail-section-title">Memory</div>' +
                '<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value">' + vm.memory + ' GB</span></div>' +
                '<div class="detail-row"><span class="detail-label">Used</span><span class="detail-value">' + vm.memoryUsed + ' GB (' + vm.memoryUsage + '%)</span></div>' +
            '</div>' +
            '<div class="detail-section">' +
                '<div class="detail-section-title">Disk</div>' +
                '<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value">' + vm.diskTotal + ' GB</span></div>' +
                '<div class="detail-row"><span class="detail-label">Used</span><span class="detail-value">' + vm.diskUsed + ' GB (' + vm.diskUsage + '%)</span></div>' +
            '</div>';

        var opsContent =
            '<div class="detail-section">' +
                '<div class="detail-section-title">Operations</div>' +
                '<div class="detail-row"><span class="detail-label">Uptime</span><span class="detail-value">' + vm.uptime + ' days</span></div>' +
                '<div class="detail-row"><span class="detail-label">Snapshots</span><span class="detail-value">' + vm.snapshotCount + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Backup Status</span><span class="detail-value">' + escapeHtml(vm.backupStatus) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Last Backup</span><span class="detail-value">' + escapeHtml(vm.lastBackup) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Owner</span><span class="detail-value">' + escapeHtml(vm.owner) + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">Created</span><span class="detail-value">' + escapeHtml(vm.createdDate) + '</span></div>' +
            '</div>';

        MobilePopup.show({
            title: vm.name,
            size: 'large',
            showFooter: false,
            tabs: [
                { id: 'overview', label: 'Overview', content: overviewContent },
                { id: 'resources', label: 'Resources', content: resourcesContent },
                { id: 'operations', label: 'Operations', content: opsContent }
            ]
        });
    }

    // Enum values for filtering
    var hvStatusEnum = { 'operational': 'operational', 'warning': 'warning', 'critical': 'critical' };
    var vmStatusEnum = { 'running': 'running', 'stopped': 'stopped', 'suspended': 'suspended', 'error': 'error' };

    var hypervisorsTable = null;
    var vmsTable = null;

    // Initialize Mobile Hosts section
    function initMobileHosts() {
        // Tab switching
        var tabs = document.querySelectorAll('.hosts-tab');
        var contents = document.querySelectorAll('.hosts-content');
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                var tabName = this.dataset.tab;
                tabs.forEach(function(t) { t.classList.remove('active'); });
                contents.forEach(function(c) { c.classList.remove('active'); });
                this.classList.add('active');
                var target = document.getElementById('hosts-' + tabName);
                if (target) target.classList.add('active');

                // Lazy init VMs table
                if (tabName === 'vms' && !vmsTable) {
                    initVmsTable();
                }
            });
        });

        // Init hypervisors table
        initHypervisorsTable();
    }

    function initHypervisorsTable() {
        var data = [];
        hypervisorsTable = new MobileTable('hypervisors-table-container', {
            data: data, serverSide: false, rowsPerPage: 15,
            columns: [
                { key: 'name', label: 'Name' },
                { key: 'type', label: 'Type' },
                { key: 'cluster', label: 'Cluster' },
                { key: 'status', label: 'Status', enumValues: hvStatusEnum }
            ],
            statusField: 'status', getStatusClass: getHvStatusClass,
            renderCard: renderHvCard, onCardClick: showHvDetail,
            emptyMessage: 'No hypervisors found.', emptyIcon: '&#x1F5A5;'
        });
    }

    function initVmsTable() {
        var data = [];
        vmsTable = new MobileTable('vms-table-container', {
            data: data, serverSide: false, rowsPerPage: 15,
            columns: [
                { key: 'name', label: 'Name' },
                { key: 'os', label: 'OS' },
                { key: 'hypervisor', label: 'Hypervisor' },
                { key: 'status', label: 'Status', enumValues: vmStatusEnum }
            ],
            statusField: 'status', getStatusClass: getVmStatusClass,
            renderCard: renderVmCard, onCardClick: showVmDetail,
            emptyMessage: 'No virtual machines found.', emptyIcon: '&#x2601;'
        });
    }

    window.initMobileHosts = initMobileHosts;
})();
</script>

<style>
/* Hosts section header */
.hosts-header {
    text-align: center;
    padding: 20px 16px 24px !important;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    margin: -12px -12px 0 -12px !important;
    border-radius: 0;
    color: white !important;
}
.hosts-header h2 { color: white !important; margin: 0 0 4px; font-size: 1.4rem; }
.hosts-header p { color: rgba(255,255,255,0.8) !important; margin: 0; opacity: 1; }

/* Tab switcher */
.hosts-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-light, #e2e8f0);
    margin: 0 -12px;
    padding: 0;
    background: var(--bg-light, #f5f7fa);
}
.hosts-tab {
    flex: 1;
    padding: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-muted, #718096);
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: -2px;
}
.hosts-tab.active {
    color: #8b5cf6;
    border-bottom-color: #8b5cf6;
    background: white;
}
.hosts-content { display: none; padding-top: 8px; }
.hosts-content.active { display: block; }

/* Host card metrics row */
.host-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}
.host-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
}
.host-metric-label {
    font-size: 0.8rem;
    color: var(--text-muted, #718096);
    font-weight: 500;
}
.host-metric-value {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-dark, #1a1a2e);
}

/* Detail popup styles (shared with gpu section) */
.detail-section { margin-bottom: 20px; }
.detail-section:last-child { margin-bottom: 0; }
.detail-section-title {
    font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
    color: var(--text-muted); margin-bottom: 12px; padding-bottom: 8px;
    border-bottom: 1px solid var(--border-light);
}
.detail-row {
    display: flex; justify-content: space-between; align-items: flex-start;
    padding: 10px 0; border-bottom: 1px solid var(--border-light);
}
.detail-row:last-child { border-bottom: none; }
.detail-label { font-size: 0.85rem; color: var(--text-muted); flex-shrink: 0; }
.detail-value {
    font-size: 0.85rem; color: var(--text-dark); font-weight: 500;
    text-align: right; word-break: break-word; margin-left: 16px;
}
.detail-value.operational { color: #22c55e; }
.detail-value.warning { color: #f59e0b; }
.detail-value.critical { color: #ef4444; }
</style>
